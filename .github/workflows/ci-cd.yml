name: CI/CD

on:
  push:
    branches:
      - dev
      - main

permissions:
  contents: write
  packages: write

jobs:
  unit-test:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Pester
      shell: pwsh
      run: Install-Module -Name Pester -Force -SkipPublisherCheck

    - name: Run Pester Tests
      id: pester
      shell: pwsh
      run: Invoke-Pester -Path .\tests\AutoSecure-VPN.Tests.ps1 -CI

  publish:
    needs: unit-test
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && needs.unit-test.result == 'success'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Publish module to PSGallery
      shell: pwsh
      env:
        PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
      run: .\publish.ps1 -ApiKey $env:PSGALLERY_API_KEY -AutoIncrement

    - name: Prepare release package
      shell: pwsh
      run: |
        $files = @(
          'src/module/AutoSecure-VPN.psm1',
          'src/module/AutoSecure-VPN.psd1',
          'src/config/Stable.psd1.example',
          'src/config/Variable.psd1.example'
        )
        $pkgDir = Join-Path $env:GITHUB_WORKSPACE 'release_pkg'
        if (Test-Path $pkgDir) { Remove-Item $pkgDir -Recurse -Force }
        New-Item -Path $pkgDir -ItemType Directory | Out-Null
        foreach ($f in $files) {
          $src = Join-Path $env:GITHUB_WORKSPACE $f
          if (-not (Test-Path $src)) { Write-Error "Missing file: $src"; exit 1 }
          Copy-Item -Path $src -Destination $pkgDir -Force
        }
        $zipPath = Join-Path $env:GITHUB_WORKSPACE 'AutoSecure-VPN-package.zip'
        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
        Compress-Archive -Path (Join-Path $pkgDir '*') -DestinationPath $zipPath -Force
        Write-Host "Created package: $zipPath"

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: Automated release from CI
        draft: false
        prerelease: false

    - name: Upload release asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./AutoSecure-VPN-package.zip
        asset_name: AutoSecure-VPN-package.zip
        asset_content_type: application/zip